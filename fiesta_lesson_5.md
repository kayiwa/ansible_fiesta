# Testing environment II

## Molecule configuration

In order to allow us to test multiple roles we create similar molecule directory
at the base of the repository. This will be used in conjunction with
symbolically linked tests to the individual role. This is also expected by
Travis and CircleCI

Our molecule is configured with the
[molecule/defaults/molecule.yml](molecule/defaults/molecule.yml) file.

```yaml
---
scenario:
  name: default
driver:
  name: docker
platforms:
  - name: instance
    image: "pulibrary/puldocker-${MOLECULE_DISTRO:-ubuntu1804}-ansible:latest"
    privileged: true
    pre_build_image: true
volumes:
  - "/sys/fs/cgroup:/sys/fs/cgroup:rw"
provisioner:
  name: ansible
  playbooks:
    converge: playbooks.yml
  log: true
dependency:
  name: galaxy
  enabled: false
lint:
  name: yamllint
  options:
    config-file: molecule/default/yaml-lint.yml
verifier:
  name: testinfra
  env:
    PYTHONWARNINGS: "ignore:.*U.*mode is deprecated:DeprecationWarning"
  lint:
    name: flake8
  options:
    # show which tests where executed in test output
    v: 1
  directory: ./tests/
```

From the autogenerated file we altered the docker image used to use a [Custom
Princeton Library](https://github.com/pulibrary/ubuntubionicimage) one.

```yaml
platforms:
  - name: instance
    image: "pulibrary/puldocker-${MOLECULE_DISTRO:-ubuntu1804}-ansible:latest"
    privileged: true
    pre_build_image: true
```

We have disabled the dependencies from Ansible Galaxy, we added a few more
configuration instruction for the verifier and flake8 to make the output less
verbose

```yaml
verifier:
  name: testinfra
  env:
    PYTHONWARNINGS: "ignore:.*U.*mode is deprecated:DeprecationWarning"
  lint:
    name: flake8
  options:
    # show which tests where executed in test output
    v: 1
  directory: ./tests/
```

Molecule provides a series of [consecutive
steps](https://molecule.readthedocs.io/en/latest/configuration.html#scenario).
The steps under the test sequence that we will use the most are `create`,
`converge`, `verify`, and `destroy`.

From the root of the repository, let's run `molecule create` If everything went fine, the log output should look
something like this:

```bash
TASK [Build an Ansible compatible image] ***************************************
    skipping: [localhost] => (item={'changed': False, 'skipped': True, 'skip_reason': 'Conditional result was False', '_ansible_no_log': False, 'item': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}, '_ansible_item_result': True, '_ansible_ignore_errors': None, '_ansible_item_label': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}})

    TASK [Create docker network(s)] ************************************************

    TASK [Create molecule instance(s)] *********************************************
    changed: [localhost] => (item={'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True})

    TASK [Wait for instance(s) creation to complete] *******************************
    changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '934147887097.62716', 'results_file': '/Users/kayiwa/.ansible_async/934147887097.62716', '_ansible_parsed': True, 'changed': True, '_ansible_no_log': False, 'failed': False, 'item': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}, '_ansible_item_result': True, '_ansible_ignore_errors': None, '_ansible_item_label': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}})

    PLAY RECAP *********************************************************************
    localhost                  : ok=3    changed=2    unreachable=0    failed=0


--> Scenario: 'default'
--> Action: 'prepare'
Skipping, prepare playbook not configured.
```

`molecule destroy` would delete this docker container but we want to write a few
tests for our nginx role

### Write tests with Testinfra

_Testinfra_ is the *Python Equivalent* to [Serverspec](https://serverspec.org/)
which is based on [Ruby's BDD framework RSpec](http://rspec.info/). Our use case
will be:

* nginx is installed
* `www-data` user and group exist
* http port is on 80
* nginx service is enabled and running

We will assert on these necessary steps inside our
testcase.[roles/nginx/molecule/default/tests/test_nginx.py](roles/nginx/molecule/default/tests/test_nginx.py) to see how this would be implemented with Testinfra:

```python
import os

import testinfra.utils.ansible_runner

testinfra_hosts = testinfra.utils.ansible_runner.AnsibleRunner(
    os.environ['MOLECULE_INVENTORY_FILE']).get_hosts('all')


def test_nginx_user(host):
    user = host.user('www-data')

    assert user.exists
    assert user.group == 'www-data'
    assert user.shell == '/usr/sbin/nologin'
    assert user.home == '/var/www'


def test_http_port(host):
    port = host.socket('tcp://0.0.0.0:80')

    assert port.is_listening


def test_nginx_service(host):
    service = host.service('nginx')

    assert service.is_enabled
    assert service.is_running
```

Testinfra is a plugin to the pytest test engine. It provides a [pytest
fixture](https://docs.pytest.org/en/latest/fixture.html#fixture) named "host".
In order to use the host fixture we need to declare it as an argument of our
test functions. The host fixture provides the [Testinfra
Modules](https://testinfra.readthedocs.io/en/latest/modules.html) that allow us
to test the state of our infrastructure. In our example we asserted if there is
a [service
running](https://testinfra.readthedocs.io/en/latest/modules.html#service), if
certain [sockets were in
use](https://testinfra.readthedocs.io/en/latest/modules.html#socket) and if
certain packages were installed. Testinfra uses `pytest` and makes is possible
to test the system after the role is run to ensure the role has the expected
results.

This role is simple and our tests will be. We are installing `nginx` and nothing
more. The [testinfra quickstart](https://testinfra.readthedocs.io/en/latest/)
has good examples you can borrow from like I did. :smile:

### Running Molecule

With our roles and tests written, we could just run `molecule test` and work
through all of steps. I have preferred using `create`, `converge`, `verify` and
`test` all separately and in that order. This has made tracking the inevitable
failures quicker. In addition this repo has a `Vagrantfile` that allows me to
spin up instances to see how installation works


#### Molecule converge

`molecule create` only acts as orchestration. The `molecule converge` step is
what runs the playbook that will call our role to configure the launched
container. A majority of the time will be spent here. Making improvements to our
role and running `molecule converge`.

```zsh
(ansible_fiesta) ansible_fiesta molecule % molecule converge
--> Validating schema /Users/kayiwa/Documents/dev/pulibrary/ansible_fiesta/molecule/default/molecule.yml.
Validation completed successfully.
--> Test matrix

└── default
    ├── dependency
    ├── create
    ├── prepare
    └── converge

--> Scenario: 'default'
--> Action: 'dependency'
Skipping, dependency is disabled.
--> Scenario: 'default'
--> Action: 'create'
Skipping, instances already created.
--> Scenario: 'default'
--> Action: 'prepare'
Skipping, prepare playbook not configured.
--> Scenario: 'default'
--> Action: 'converge'

    PLAY [Converge] ****************************************************************

    TASK [Gathering Facts] *********************************************************
    ok: [instance]

    TASK [roles/nginx : Check if nginx is installed] *******************************
    ok: [instance]

    TASK [roles/nginx : Add nginx APT GPG key] *************************************
    changed: [instance]

    TASK [roles/nginx : Add nginx APT repository] **********************************
    changed: [instance]

    TASK [roles/nginx : install nginx] *********************************************
    changed: [instance]

    TASK [roles/nginx : Create default nginx directories] **************************
    ok: [instance] => (item=/etc/nginx/sites-available)
    ok: [instance] => (item=/etc/nginx/sites-enabled)
...
```

#### Molecule verify

`molecule verify` will run our tests and as this example shows there's some
errors that it found. We would continue fix the problem. (this one is
particularly tricky because we would need a docker image that can run systemd) 

```zsh
(ansible_fiesta) ansible_fiesta molecule % molecule verify
--> Validating schema /Users/kayiwa/Documents/dev/pulibrary/ansible_fiesta/molecule/default/molecule.yml.
Validation completed successfully.
--> Test matrix

└── default
    └── verify

--> Scenario: 'default'
--> Action: 'verify'
--> Executing Testinfra tests found in /Users/kayiwa/Documents/dev/pulibrary/ansible_fiesta/molecule/default/./tests//...
    ============================= test session starts ==============================
    platform darwin -- Python 3.7.2, pytest-4.3.1, py-1.8.0, pluggy-0.9.0 -- /Users/kayiwa/.local/share/virtualenvs/ansible_fiesta-1KN6kVYA/bin/python3.7
    rootdir: /Users/kayiwa/Documents/dev/pulibrary/ansible_fiesta/molecule/default, inifile:
    plugins: testinfra-1.16.0
collected 5 items

    ::test_is_nginx_installed[ansible://instance] PASSED                     [ 20%]
    ::test_nginx_config_exists[ansible://instance] PASSED                    [ 40%]
    ::test_nginx_user[ansible://instance] PASSED                             [ 60%]
    ::test_http_port[ansible://instance] PASSED                              [ 80%]
    ::test_nginx_service[ansible://instance] FAILED                          [100%]

    =================================== FAILURES ===================================
    ____________________ test_nginx_service[ansible://instance] ____________________

    host = <testinfra.host.Host object at 0x10d2cbbe0>

        def test_nginx_service(host):
            service = host.service('nginx')

            assert service.is_enabled
    >       assert service.is_running

    ../../roles/nginx/molecule/default/tests/test_nginx.py:40:
    _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
    self = <service nginx>

        @property
        def is_running(self):
            return self.run_expect(
    >           [0, 3], "systemctl is-active %s", self.name).rc == 0
    E       AssertionError: Unexpected exit code 1 for CommandResult(command='systemctl is-active nginx', exit_status=1, stdout='', stderr="System has not been booted with systemd as init system (PID 1). Can't operate.")
    E       assert 1 in [0, 3]
    E        +  where 1 = CommandResult(command='systemctl is-active nginx', exit_status=1, stdout='', stderr="System has not been booted with systemd as init system (PID 1). Can't operate.").rc

    /Users/kayiwa/.local/share/virtualenvs/ansible_fiesta-1KN6kVYA/lib/python3.7/site-packages/testinfra/modules/service.py:107: AssertionError
```

#### Molecule test

When we resolve this would run `molecule test`. This would destroy any existing
docker containers, check the syntax on the role, create a new docker container,
run the playbook, lint and run our tests.
