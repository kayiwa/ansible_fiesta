# Testing environment II

## Molecule configuration

In order to allow us to test multiple roles we create similar molecule directory
at the base of the repository. This will be used in conjunction with
symbolically linked tests in the individual repository. This is also expected by
Travis and CircleCI

Our molecule is configured with the
[molecule/defaults/molecule.yml](molecule/defaults/molecule.yml) file.

```yaml
---
scenario:
  name: default
driver:
  name: docker
platforms:
  - name: instance
    image: "pulibrary/puldocker-${MOLECULE_DISTRO:-ubuntu1804}-ansible:latest"
    privileged: true
    pre_build_image: true
volumes:
  - "/sys/fs/cgroup:/sys/fs/cgroup:rw"
provisioner:
  name: ansible
  playbooks:
    converge: playbooks.yml
  log: true
dependency:
  name: galaxy
  enabled: false
lint:
  name: yamllint
  options:
    config-file: molecule/default/yaml-lint.yml
verifier:
  name: testinfra
  env:
    PYTHONWARNINGS: "ignore:.*U.*mode is deprecated:DeprecationWarning"
  lint:
    name: flake8
  options:
    # show which tests where executed in test output
    v: 1
  directory: ./tests/
```

From the autogenerated file we altered the docker image used to use a [Custom
Princeton Library](https://github.com/pulibrary/ubuntubionicimage) one.

```yaml
platforms:
  - name: instance
    image: "pulibrary/puldocker-${MOLECULE_DISTRO:-ubuntu1804}-ansible:latest"
    privileged: true
    pre_build_image: true
```

We have disabled the dependencies from Ansible Galaxy, we added a few more
configuration instruction for the verifier and flake8 to make the output less
verbose

```yaml
verifier:
  name: testinfra
  env:
    PYTHONWARNINGS: "ignore:.*U.*mode is deprecated:DeprecationWarning"
  lint:
    name: flake8
  options:
    # show which tests where executed in test output
    v: 1
  directory: ./tests/
```

Molecule provides a series of [consecutive
steps](https://molecule.readthedocs.io/en/latest/configuration.html#scenario).
The steps under the test sequence that we will use the most are `create`,
`converge`, `verify`, and `destroy`.

Let's run `molecule create` If everything went fine, the log output should look
something like this:

```bash
TASK [Build an Ansible compatible image] ***************************************
    skipping: [localhost] => (item={'changed': False, 'skipped': True, 'skip_reason': 'Conditional result was False', '_ansible_no_log': False, 'item': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}, '_ansible_item_result': True, '_ansible_ignore_errors': None, '_ansible_item_label': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}})

    TASK [Create docker network(s)] ************************************************

    TASK [Create molecule instance(s)] *********************************************
    changed: [localhost] => (item={'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True})

    TASK [Wait for instance(s) creation to complete] *******************************
    changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '934147887097.62716', 'results_file': '/Users/kayiwa/.ansible_async/934147887097.62716', '_ansible_parsed': True, 'changed': True, '_ansible_no_log': False, 'failed': False, 'item': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}, '_ansible_item_result': True, '_ansible_ignore_errors': None, '_ansible_item_label': {'name': 'instance', 'image': 'pulibrary/puldocker-ubuntu1804-ansible:latest', 'privileged': True, 'pre_build_image': True}})

    PLAY RECAP *********************************************************************
    localhost                  : ok=3    changed=2    unreachable=0    failed=0


--> Scenario: 'default'
--> Action: 'prepare'
Skipping, prepare playbook not configured.
```

`molecule destroy` would delete this docker container but we want to write a few
tests for our nginx role

### Write tests with Testinfra

_Testinfra_ is the *Python Equivalent* to [Serverspec](https://serverspec.org/)
which is based on [Ruby's BDD framework RSpec](http://rspec.info/). Our use case
will be:

* nginx is installed
* `www-data` user and group exist
* http port is on 80
* nginx service is enabled and running

We will assert on these necessary steps inside our
testcase.[roles/nginx/molecule/default/tests/test_nginx.py](roles/nginx/molecule/default/tests/test_nginx.py) to see how this would be implemented with Testinfra:

```python
import os

import testinfra.utils.ansible_runner

testinfra_hosts = testinfra.utils.ansible_runner.AnsibleRunner(
    os.environ['MOLECULE_INVENTORY_FILE']).get_hosts('all')


def test_nginx_user(host):
    user = host.user('www-data')

    assert user.exists
    assert user.group == 'www-data'
    assert user.shell == '/usr/sbin/nologin'
    assert user.home == '/var/www'


def test_http_port(host):
    port = host.socket('tcp://0.0.0.0:80')

    assert port.is_listening


def test_nginx_service(host):
    service = host.service('nginx')

    assert service.is_enabled
    assert service.is_running
```

Testinfra is a plugin to the pytest test engine. It provides a [pytest
fixture](https://docs.pytest.org/en/latest/fixture.html#fixture) named "host".
In order to use the host fixture we need to declare it as an argument of our
test functions. The host fixture provides the [Testinfra
Modules](https://testinfra.readthedocs.io/en/latest/modules.html).
