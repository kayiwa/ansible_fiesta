# Testing environment II

## Molecule configuration

In order to allow us to test multiple roles we create similar molecule directory
at the base of the repository. This will be used in conjunction with
symbolically linked tests in the individual repository. This is also expected by
Travis and CircleCI

Our molecule is configured with the
[molecule/defaults/molecule.yml](molecule/defaults/molecule.yml) file.

```yaml
---
scenario:
  name: default
driver:
  name: docker
platforms:
  - name: instance
    image: "pulibrary/puldocker-${MOLECULE_DISTRO:-ubuntu1804}-ansible:latest"
    privileged: true
    pre_build_image: true
volumes:
  - "/sys/fs/cgroup:/sys/fs/cgroup:rw"
provisioner:
  name: ansible
  playbooks:
    converge: playbooks.yml
  log: true
dependency:
  name: galaxy
  enabled: false
lint:
  name: yamllint
  options:
    config-file: molecule/default/yaml-lint.yml
verifier:
  name: testinfra
  env:
    PYTHONWARNINGS: "ignore:.*U.*mode is deprecated:DeprecationWarning"
  lint:
    name: flake8
  options:
    # show which tests where executed in test output
    v: 1
  directory: ./tests/
```

From the autogenerated file we altered the docker image used to use a [Custom
Princeton Library](https://github.com/pulibrary/ubuntubionicimage) one.

```yaml
platforms:
  - name: instance
    image: "pulibrary/puldocker-${MOLECULE_DISTRO:-ubuntu1804}-ansible:latest"
    privileged: true
    pre_build_image: true
```

We have disabled the dependencies from Ansible Galaxy, we added a few more
configuration instruction for the verifier and flake8 to make the output less
verbose

```yaml
verifier:
  name: testinfra
  env:
    PYTHONWARNINGS: "ignore:.*U.*mode is deprecated:DeprecationWarning"
  lint:
    name: flake8
  options:
    # show which tests where executed in test output
    v: 1
  directory: ./tests/
```
